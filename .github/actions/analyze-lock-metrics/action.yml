name: 'Analyze Lock Metrics'
description: 'Download, merge and analyze lock metrics'
runs:
  using: "composite"
  steps:
    - name: Download all lock metrics
      uses: actions/download-artifact@v4
      with:
        pattern: lock-metrics-*
        merge-multiple: false
        path: lock-metrics-shards

    - name: Merge lock metrics from all shards
      shell: bash
      run: |
        echo "Merging lock metrics from all shards..."
        mkdir -p diagnostics
        
        # Check if any metric files exist
        if find lock-metrics-shards -name "lock-metrics-*.json" | grep -q .; then
          echo "Found metric files, merging..."
          # Merge all JSON arrays from all files into one
          find lock-metrics-shards -name "lock-metrics-*.json" -exec cat {} + | jq -s 'add' > diagnostics/lock-metrics.json
        else
          echo "No lock metrics found."
          echo "[]" > diagnostics/lock-metrics.json
        fi

        # Ensure valid JSON array
        if [ ! -s diagnostics/lock-metrics.json ] || [ "$(cat diagnostics/lock-metrics.json)" = "null" ]; then
           echo "[]" > diagnostics/lock-metrics.json
        fi
        
        echo "Merged metrics count: $(jq 'length' diagnostics/lock-metrics.json)"

    - name: Analyze lock metrics
      shell: bash
      run: |
        echo "================================================"
        echo "           LOCK METRICS ANALYSIS (CI)"
        echo "================================================"
        npm run analyze:lock-metrics
        echo "================================================"

    - name: Generate HTML Report
      shell: bash
      run: |
        echo "Generating interactive HTML dashboard..."
        npm run generate:lock-report
        ls -lh diagnostics/lock-metrics-report.html

    - name: Upload lock metrics and HTML report
      uses: actions/upload-artifact@v4
      with:
        name: lock-metrics-report
        path: |
          diagnostics/lock-metrics*.json
          diagnostics/lock-metrics-report.html
        retention-days: 30
