name: Cucumber Tests

on:
  workflow_dispatch:
    inputs:
      tags:
        description: 'Select a tag to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - '@brand'
          - '@price'
          - '@search'
          - '@detail'
          - '@combination'

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
    - name: Cache node_modules
      uses: actions/cache@v4
      id: node-modules-cache
      with:
        path: node_modules
        key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-modules-
    - name: Install dependencies
      if: steps.node-modules-cache.outputs.cache-hit != 'true'
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Cucumber tests
      run: |
        TAGS_ARG=""
        if [ "${{ github.event.inputs.tags }}" != "all" ] && [ -n "${{ github.event.inputs.tags }}" ]; then
          TAGS_ARG="--tags '${{ github.event.inputs.tags }}'"
        fi
        npm run test:cucumber:shard -- --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} $TAGS_ARG
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cucumber-report-${{ matrix.shardIndex }}
        path: |
          cucumber-report-${{ matrix.shardIndex }}.html
          cucumber-report-${{ matrix.shardIndex }}.json
        retention-days: 1

  merge-reports:
    if: always()
    needs: [test]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    - name: Cache node_modules
      uses: actions/cache@v4
      id: node-modules-cache
      with:
        path: node_modules
        key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-modules-
    - name: Install dependencies
      if: steps.node-modules-cache.outputs.cache-hit != 'true'
      run: npm ci
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: cucumber-report-*
        merge-multiple: true
        path: all-cucumber-reports

    - name: Merge reports
      run: node scripts/merge-cucumber-reports.js

    - name: Install Playwright Chromium
      run: npx playwright install --with-deps chromium

    - name: Capture Report Screenshot
      run: node scripts/capture-report-screenshot.js

    - uses: actions/upload-artifact@v4
      with:
        name: cucumber-html-report
        path: cucumber-report
        retention-days: 30

    - uses: actions/upload-artifact@v4
      with:
        name: cucumber-report-summary
        path: cucumber-report/cucumber-report-summary.png
        retention-days: 30
