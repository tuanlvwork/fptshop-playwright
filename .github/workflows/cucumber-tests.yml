name: Cucumber Tests

on:
  workflow_dispatch:
    inputs:
      tags:
        description: 'Select a tag to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          # Domain tags
          - '@fptshop'
          - '@saucedemo'
          # FPT Shop specific tags
          - '@fptshop and @brand'
          - '@fptshop and @price'
          - '@fptshop and @search'
          - '@fptshop and @detail'
          - '@fptshop and @combination'
          # SauceDemo specific tags
          - '@saucedemo and @smoke'
          - '@saucedemo and @login'
          - '@saucedemo and @cart'
          - '@saucedemo and @checkout'
          - '@saucedemo and @standard'
          - '@saucedemo and @negative'
      shardTotal:
        description: 'Total number of shards'
        required: true
        default: '8'
        type: string
      parallelWorkers:
        description: 'Number of parallel workers per shard'
        required: true
        default: '4'
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      shardTotal: ${{ steps.set-matrix.outputs.shardTotal }}
      parallelWorkers: ${{ steps.set-matrix.outputs.parallelWorkers }}
      startTime: ${{ steps.get-timestamp.outputs.startTime }}
    steps:
      - id: get-timestamp
        run: echo "startTime=$(date +%s)" >> $GITHUB_OUTPUT

      - id: set-matrix
        run: |
          count=${{ inputs.shardTotal }}
          workers=${{ inputs.parallelWorkers }}
          echo "shardTotal=$count" >> $GITHUB_OUTPUT
          echo "parallelWorkers=$workers" >> $GITHUB_OUTPUT
          matrix="["
          for ((i=1; i<=count; i++)); do
            matrix="${matrix}${i}"
            if [ $i -lt $count ]; then
              matrix="${matrix}, "
            fi
          done
          matrix="${matrix}]"
          echo "matrix=${matrix}" >> $GITHUB_OUTPUT

  validate:
    name: Quick Validation
    needs: setup
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-noble
    steps:
      - name: Setup App
        uses: ./.github/actions/setup-app
        with:
          node-version: '20'
          install-deps: 'true'

      - name: Run Validation Check
        uses: ./.github/actions/run-validation

  test:
    needs: [setup, validate]
    timeout-minutes: 60
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-noble
    strategy:
      fail-fast: false
      matrix:
        shardIndex: ${{ fromJson(needs.setup.outputs.matrix) }}
        shardTotal: [ "${{ needs.setup.outputs.shardTotal }}" ]
    steps:
      - name: Setup App
        uses: ./.github/actions/setup-app
        with:
          node-version: '20'
          install-deps: 'true'

      - name: Check Playwright Version
        uses: ./.github/actions/check-playwright-version

      - name: Run Cucumber Tests
        uses: ./.github/actions/run-cucumber-tests
        with:
          shard-index: ${{ matrix.shardIndex }}
          shard-total: ${{ matrix.shardTotal }}
          parallel-workers: ${{ needs.setup.outputs.parallelWorkers }}
          tags: ${{ github.event.inputs.tags }}

  merge-reports:
    if: always()
    needs: [setup, test]
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-noble
    steps:
      - name: Setup App
        uses: ./.github/actions/setup-app
        with:
          node-version: '20'
          install-deps: 'true'

      - name: Check Playwright Version
        uses: ./.github/actions/check-playwright-version

      - name: Merge Cucumber Results
        uses: ./.github/actions/merge-cucumber-results
        with:
          start-time: ${{ needs.setup.outputs.startTime }}

  allure-report:
    if: always()
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Setup App
        uses: ./.github/actions/setup-app
        with:
          node-version: '20'
          install-deps: 'false'

      - name: Generate Allure Report
        uses: ./.github/actions/generate-allure-report

  lock-metrics-analysis:
    if: always()
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Setup App
        uses: ./.github/actions/setup-app
        with:
          node-version: '20'
          install-deps: 'true'

      - name: Analyze Lock Metrics
        uses: ./.github/actions/analyze-lock-metrics
